<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>5 Trait data curation and analysis | PFTC Teaching Material</title>
<meta name="author" content="Aud Halbritter">
<meta name="description" content="5.1 Introduction to R/RStudio, data analysis and more The Biostats books are an extensive resource for getting started with R and RStudio, working in R, coding, using Rmarkdown, git and GitHub and...">
<meta name="generator" content="bookdown 0.24 with bs4_book()">
<meta property="og:title" content="5 Trait data curation and analysis | PFTC Teaching Material">
<meta property="og:type" content="book">
<meta property="og:description" content="5.1 Introduction to R/RStudio, data analysis and more The Biostats books are an extensive resource for getting started with R and RStudio, working in R, coding, using Rmarkdown, git and GitHub and...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="5 Trait data curation and analysis | PFTC Teaching Material">
<meta name="twitter:description" content="5.1 Introduction to R/RStudio, data analysis and more The Biostats books are an extensive resource for getting started with R and RStudio, working in R, coding, using Rmarkdown, git and GitHub and...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.12/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><link rel="stylesheet" href="css/style-chapters.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">PFTC Teaching Material</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">PFTC Teaching material</a></li>
<li><a class="" href="pftc-6-course-information.html"><span class="header-section-number">1</span> PFTC 6 Course information</a></li>
<li><a class="" href="the-study-system.html"><span class="header-section-number">2</span> The study system</a></li>
<li><a class="" href="resources-for-field-work-and-trait-measurements.html"><span class="header-section-number">3</span> Resources for field work and trait measurements</a></li>
<li><a class="" href="working-with-pftc-data.html"><span class="header-section-number">4</span> Working with PFTC data</a></li>
<li><a class="active" href="trait-data-curation-and-analysis.html"><span class="header-section-number">5</span> Trait data curation and analysis</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="trait-data-curation-and-analysis" class="section level1" number="5">
<h1>
<span class="header-section-number">5</span> Trait data curation and analysis<a class="anchor" aria-label="anchor" href="#trait-data-curation-and-analysis"><i class="fas fa-link"></i></a>
</h1>

<div id="introduction-to-rrstudio-data-analysis-and-more" class="section level2" number="5.1">
<h2>
<span class="header-section-number">5.1</span> Introduction to R/RStudio, data analysis and more<a class="anchor" aria-label="anchor" href="#introduction-to-rrstudio-data-analysis-and-more"><i class="fas fa-link"></i></a>
</h2>
<p>The <a href="https://biostats-r.github.io/biostats/index.html">Biostats books</a> are an extensive resource for getting started with R and RStudio, working in R, coding, using Rmarkdown, git and GitHub and creating an R package.</p>
<div class="inline-figure"><img src="images/resources/icons_all.jpg" width="100%"></div>

</div>
<div id="data-curation" class="section level2" number="5.2">
<h2>
<span class="header-section-number">5.2</span> Data curation<a class="anchor" aria-label="anchor" href="#data-curation"><i class="fas fa-link"></i></a>
</h2>
<p>Data curation, transformation or cleaning is the first step after digitizing the data.
Each dataset has to be checked for errors and corrected as best as possible.
This tutorial shows how to check your dataset for errors and how to correct them.</p>
<p>There are a couple of R packages that are useful for this work.</p>
<p>If you have never used the packages you need to install them first using the function <code><a href="https://rdrr.io/r/utils/install.packages.html">install.packages()</a></code>.
Otherwise, you can just load the packages.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></code></pre></div>
<p>For this tutorial we will be working with the trait dataset from Svalbard.
See section @ref(Working with PFTC data) for how to access the data and information about the study, experiment and datasets.</p>
<div id="import-data" class="section level3" number="5.2.1">
<h3>
<span class="header-section-number">5.2.1</span> Import data<a class="anchor" aria-label="anchor" href="#import-data"><i class="fas fa-link"></i></a>
</h3>
<p>The first step is to import the data to R.
The data is stored as a <em>csv file</em> and we can use the function <code><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv()</a></code> to import that data.
If your data has another format or importing data is new to, you have a look at this <a href="https://biostats-r.github.io/biostats/workingInR/importing-data-in-r.html">page</a>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">raw_traits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"data/PFTC4_Svalbard_2018_Gradient_Traits.csv"</span><span class="op">)</span>
<span class="co">#&gt; Rows: 11345 Columns: 15</span>
<span class="co">#&gt; ── Column specification ────────────────────────────────────────────────────────</span>
<span class="co">#&gt; Delimiter: ","</span>
<span class="co">#&gt; chr  (7): Project, Gradient, PlotID, ID, Functional_group, Taxon, Trait</span>
<span class="co">#&gt; dbl  (7): Year, Site, Individual_nr, Value, Elevation_m, Latitude_N, Longitu...</span>
<span class="co">#&gt; date (1): Date</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ℹ Use `spec()` to retrieve the full column specification for this data.</span>
<span class="co">#&gt; ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</span></code></pre></div>
<p>Give the dataset a name that indicates that this is the raw data.</p>
<p>Let us now shrink the dataset to make it easier to handle.
In addition, we will introduce a couple of errors that we want to fix afterwards.</p>
<p>The code to do this is hidden.
But if you want to replicate the introduction to the errors you can find the code here.</p>
<pre><code>#&gt; filter: removed 8,525 rows (75%), 2,820 rows remaining
#&gt; select: dropped 3 variables (Project, Year, Functional_group)
#&gt; mutate: converted 'Date' from Date to character (0 new NA)
#&gt;         changed 28 values (1%) of 'Taxon' (0 new NA)
#&gt;         changed 4 values (&lt;1%) of 'Value' (3 new NA)
#&gt; slice: removed 2,819 rows (&gt;99%), one row remaining
#&gt; filter: removed 2,572 rows (91%), 248 rows remaining
#&gt; sample_n: removed 198 rows (80%), 50 rows remaining
#&gt; mutate: new variable 'Value2' (double) with 38 unique values and 0% NA
#&gt; Joining, by = c("Date", "Gradient", "Site", "PlotID", "Individual_nr", "ID",
#&gt; "Taxon", "Trait", "Value", "Elevation_m", "Latitude_N", "Longitude_E")
#&gt; left_join: added one column (Value2)
#&gt; &gt; rows only in x 2,770
#&gt; &gt; rows only in y ( 0)
#&gt; &gt; matched rows 50
#&gt; &gt; =======
#&gt; &gt; rows total 2,820
#&gt; mutate: changed 50 values (2%) of 'Value' (0 new NA)
#&gt; select: dropped one variable (Value2)</code></pre>
</div>
<div id="first-check-of-the-dataset" class="section level3" number="5.2.2">
<h3>
<span class="header-section-number">5.2.2</span> First check of the dataset<a class="anchor" aria-label="anchor" href="#first-check-of-the-dataset"><i class="fas fa-link"></i></a>
</h3>
<p>By typing <code>raw_traits</code> in the console it will display the first rows and columns of the dataset.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">raw_traits</span>
<span class="co">#&gt; # A tibble: 2,821 × 12</span>
<span class="co">#&gt;    Date       Gradient  Site PlotID Individual_nr ID      Taxon    Trait   Value</span>
<span class="co">#&gt;    &lt;chr&gt;      &lt;chr&gt;    &lt;dbl&gt; &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;    &lt;chr&gt;   &lt;dbl&gt;</span>
<span class="co">#&gt;  1 2018-07-20 B            5 B                  3 AXL1488 poa arc… Plan… 5   e+0</span>
<span class="co">#&gt;  2 2018-07-20 B            5 B                  3 AXL1488 poa arc… Leaf… 1.50e-1</span>
<span class="co">#&gt;  3 2018-07-20 B            5 B                  2 AXM6346 poa arc… Plan… 5.5 e+0</span>
<span class="co">#&gt;  4 2018-07-20 B            5 B                  2 AXM6346 poa arc… Wet_… 1.43e-2</span>
<span class="co">#&gt;  5 2018-07-20 B            5 B                  2 AXM6346 poa arc… Dry_… 3.33e-3</span>
<span class="co">#&gt;  6 2018-07-20 B            5 B                  2 AXM6346 poa arc… Leaf… 2.44e-1</span>
<span class="co">#&gt;  7 2018-07-20 B            5 B                  2 AXM6346 poa arc… Leaf… 6.22e-1</span>
<span class="co">#&gt;  8 2018-07-20 B            5 B                  2 AXM6346 poa arc… SLA_… 1.87e+2</span>
<span class="co">#&gt;  9 2018-07-20 B            5 B                  2 AXM6346 poa arc… LDMC  2.33e-1</span>
<span class="co">#&gt; 10 2018-07-20 B            5 B                  1 AXN0475 poa arc… Plan… 6   e+0</span>
<span class="co">#&gt; # … with 2,811 more rows, and 3 more variables: Elevation_m &lt;dbl&gt;,</span>
<span class="co">#&gt; #   Latitude_N &lt;dbl&gt;, Longitude_E &lt;dbl&gt;</span></code></pre></div>
<p>This will allow you to git the dataset a first rough check.
The dataset has 2821 observations and 12 columns.
These numbers give you a first impression if you have imported the right file, and if all your observations and columns are there.</p>
</div>
<div id="check-the-data-typeclass" class="section level3" number="5.2.3">
<h3>
<span class="header-section-number">5.2.3</span> Check the data type/class<a class="anchor" aria-label="anchor" href="#check-the-data-typeclass"><i class="fas fa-link"></i></a>
</h3>
<p>The next thing to check is if the variables have the right data type/class.
For each variable you can see what type of formate it has, <em>dbl</em> (numeric or integer), <em>chr</em> (character), or <em>date</em> (date) are the most common data types.</p>
<p>If you want to know more about data types see <a href="https://biostats-r.github.io/biostats/workingInR/first-steps-in-r.html#data-types-and-objects">here</a>.</p>
<p>Now check if the variables are in the right format?
We see that the first variable <em>Date</em> is a character, which is not the right format.
This probably means that one of the dates is not a date.
Let us check all the different dates in the variable <em>Date</em>.
For this we can use the function <code><a href="https://rdrr.io/pkg/tidylog/man/distinct.html">distinct()</a></code> on the variable <em>Date</em>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">raw_traits</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="va">Date</span><span class="op">)</span>
<span class="co">#&gt; distinct: removed 2,815 rows (&gt;99%), 6 rows remaining</span>
<span class="co">#&gt; # A tibble: 6 × 1</span>
<span class="co">#&gt;   Date      </span>
<span class="co">#&gt;   &lt;chr&gt;     </span>
<span class="co">#&gt; 1 2018-07-20</span>
<span class="co">#&gt; 2 2018-07-21</span>
<span class="co">#&gt; 3 2018-07-18</span>
<span class="co">#&gt; 4 18        </span>
<span class="co">#&gt; 5 2018-07-17</span>
<span class="co">#&gt; 6 2018-07-19</span></code></pre></div>
<p>We can now see that there are 6 distinct dates in the dataset.
And one of the dates is “18”, which is what caused the problem to not recognize this variable as a date.</p>
<p>The next step is to check which observation was the problem or if there are several.
For this we can use the function <code><a href="https://rdrr.io/pkg/tidylog/man/filter.html">filter()</a></code> to extract all observations with a date 18.
We can use <code><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame()</a></code> to display the whole table.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">raw_traits</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">Date</span> <span class="op">==</span> <span class="st">"18"</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; filter: removed 2,814 rows (&gt;99%), 7 rows remaining</span>
<span class="co">#&gt;   Date Gradient Site PlotID Individual_nr      ID         Taxon</span>
<span class="co">#&gt; 1   18        C    1      A             3 AMO3822 salix polaris</span>
<span class="co">#&gt; 2   18        C    1      A             3 AMO3822 salix polaris</span>
<span class="co">#&gt; 3   18        C    1      A             3 AMO3822 salix polaris</span>
<span class="co">#&gt; 4   18        C    1      A             3 AMO3822 salix polaris</span>
<span class="co">#&gt; 5   18        C    1      A             3 AMO3822 salix polaris</span>
<span class="co">#&gt; 6   18        C    1      A             3 AMO3822 salix polaris</span>
<span class="co">#&gt; 7   18        C    1      A             3 AMO3822 salix polaris</span>
<span class="co">#&gt;               Trait       Value Elevation_m Latitude_N Longitude_E</span>
<span class="co">#&gt; 1   Plant_Height_cm   1.1000000    9.916197   78.21307    15.71207</span>
<span class="co">#&gt; 2        Wet_Mass_g   0.0057600    9.916197   78.21307    15.71207</span>
<span class="co">#&gt; 3        Dry_Mass_g   0.0000020    9.916197   78.21307    15.71207</span>
<span class="co">#&gt; 4 Leaf_Thickness_mm   0.1880000    9.916197   78.21307    15.71207</span>
<span class="co">#&gt; 5     Leaf_Area_cm2   0.2840000    9.916197   78.21307    15.71207</span>
<span class="co">#&gt; 6         SLA_cm2_g 142.0000000    9.916197   78.21307    15.71207</span>
<span class="co">#&gt; 7              LDMC   0.3472222    9.916197   78.21307    15.71207</span></code></pre></div>
<p>We can see that it is a single observation that has the wrong date.
The next step is to check the raw data, notes, photos, etc. to find the correct date for this observations.
It is important to keep the raw data sheets, or take a photo of them to be able to check these problems afterwards.</p>
<p>Since the value for date is 18, we will assume now that this was a typo and that the correct date is 2018-07-18.
Let’s replace this value and give the variable the right class.</p>
<p>For this we will use the function <code><a href="https://rdrr.io/pkg/tidylog/man/mutate.html">mutate()</a></code> which can be used to manipulate a column.
Inside the mutate we will use the <code><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else()</a></code> function to replace the date for a specific ID.
To give the variable the correct class, we use the <code>ymd()</code> function from the lubridate package.
Note that we now have to assign the table to a new or the same name to make the change permanent.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">raw_traits</span> <span class="op">&lt;-</span> <span class="va">raw_traits</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Date <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">ID</span> <span class="op">==</span> <span class="st">"AMO3822"</span>, <span class="st">"2018-07-18"</span>, <span class="va">Date</span><span class="op">)</span>,
         Date <span class="op">=</span> <span class="fu">ymd</span><span class="op">(</span><span class="va">Date</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; mutate: converted 'Date' from character to Date (0 new NA)</span></code></pre></div>
<p>An important step when cleaning data is to check that you have done the right thing.
One way to do this here is to look at the specific leaf (ID == “AMO3822”) and see if the date is now corrected.
Another way would be to run the <code>distinct(Date)</code> function again.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">raw_traits</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">ID</span> <span class="op">==</span> <span class="st">"AMO3822"</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; filter: removed 2,814 rows (&gt;99%), 7 rows remaining</span>
<span class="co">#&gt;         Date Gradient Site PlotID Individual_nr      ID         Taxon</span>
<span class="co">#&gt; 1 2018-07-18        C    1      A             3 AMO3822 salix polaris</span>
<span class="co">#&gt; 2 2018-07-18        C    1      A             3 AMO3822 salix polaris</span>
<span class="co">#&gt; 3 2018-07-18        C    1      A             3 AMO3822 salix polaris</span>
<span class="co">#&gt; 4 2018-07-18        C    1      A             3 AMO3822 salix polaris</span>
<span class="co">#&gt; 5 2018-07-18        C    1      A             3 AMO3822 salix polaris</span>
<span class="co">#&gt; 6 2018-07-18        C    1      A             3 AMO3822 salix polaris</span>
<span class="co">#&gt; 7 2018-07-18        C    1      A             3 AMO3822 salix polaris</span>
<span class="co">#&gt;               Trait       Value Elevation_m Latitude_N Longitude_E</span>
<span class="co">#&gt; 1   Plant_Height_cm   1.1000000    9.916197   78.21307    15.71207</span>
<span class="co">#&gt; 2        Wet_Mass_g   0.0057600    9.916197   78.21307    15.71207</span>
<span class="co">#&gt; 3        Dry_Mass_g   0.0000020    9.916197   78.21307    15.71207</span>
<span class="co">#&gt; 4 Leaf_Thickness_mm   0.1880000    9.916197   78.21307    15.71207</span>
<span class="co">#&gt; 5     Leaf_Area_cm2   0.2840000    9.916197   78.21307    15.71207</span>
<span class="co">#&gt; 6         SLA_cm2_g 142.0000000    9.916197   78.21307    15.71207</span>
<span class="co">#&gt; 7              LDMC   0.3472222    9.916197   78.21307    15.71207</span></code></pre></div>
<p>We can see that the date has been fixed.</p>
</div>
<div id="exercise-1" class="section level3 unnumbered exercise toc-ignore">
<h3>Exercise<a class="anchor" aria-label="anchor" href="#exercise-1"><i class="fas fa-link"></i></a>
</h3>
<p>Now it is your turn.
Check if the data type for the variable <em>Date</em> is now correct.</p>
<details><summary>
Hint
</summary><ul>
<li>type <code>raw_traits</code> to look at the whole dataset where the datatype of each variable is indicated</li>
<li>use <code>class(raw_traits)</code> which will tell you directly what type of class the variable has</li>
</ul></details>
</div>
<div id="check-for-duplicates" class="section level3" number="5.2.4">
<h3>
<span class="header-section-number">5.2.4</span> Check for duplicates<a class="anchor" aria-label="anchor" href="#check-for-duplicates"><i class="fas fa-link"></i></a>
</h3>
<p>Another common problem is duplicate observations.
This can happen when data is entered twice.
The why to find duplicates is to check that the combination of variables are unique.
In our dataset, we expect that <em>Date</em>, <em>Gradient</em>, <em>Site</em>, <em>PlotID</em>, <em>Individual_nr</em>, <em>ID</em>, <em>Taxon</em> and <em>Trait</em> should be unique, and only occurring once.</p>
<p>To check this, we can <code><a href="https://rdrr.io/pkg/tidylog/man/group_by.html">group_by()</a></code> these variables and <code><a href="https://rdrr.io/pkg/tidylog/man/filter.html">filter()</a></code> for observations that occur more than once.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">raw_traits</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Date</span>, <span class="va">Gradient</span>, <span class="va">Site</span>, <span class="va">PlotID</span>, <span class="va">Individual_nr</span>, <span class="va">ID</span>, <span class="va">Taxon</span>, <span class="va">Trait</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span>
<span class="co">#&gt; group_by: 8 grouping variables (Date, Gradient, Site, PlotID, Individual_nr, …)</span>
<span class="co">#&gt; filter (grouped): removed 2,819 rows (&gt;99%), 2 rows remaining</span>
<span class="co">#&gt; # A tibble: 2 × 12</span>
<span class="co">#&gt; # Groups:   Date, Gradient, Site, PlotID, Individual_nr, ID, Taxon, Trait [1]</span>
<span class="co">#&gt;   Date       Gradient  Site PlotID Individual_nr ID      Taxon       Trait Value</span>
<span class="co">#&gt;   &lt;date&gt;     &lt;chr&gt;    &lt;dbl&gt; &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;       &lt;chr&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1 2018-07-20 B            3 C                  1 BGS3406 luzula con… SLA_…  158.</span>
<span class="co">#&gt; 2 2018-07-20 B            3 C                  1 BGS3406 luzula con… SLA_…  158.</span>
<span class="co">#&gt; # … with 3 more variables: Elevation_m &lt;dbl&gt;, Latitude_N &lt;dbl&gt;,</span>
<span class="co">#&gt; #   Longitude_E &lt;dbl&gt;</span></code></pre></div>
<p>We can see that there is one duplicate entry which is exactly the same.
Note that <em>Value</em> was not included in the <code><a href="https://rdrr.io/pkg/tidylog/man/group_by.html">group_by()</a></code>.
This was done intentionally, because a common mistake is to have a duplicate, but with a different value.
This is either because one of the variables is wrong, e.g. it has the wrong Site and therefore appears to be a duplicate.
Alternatively, the leaf could have been measured twice by accident, which would likely give two slightly different values.
When getting a duplicate, these different options for why there is a duplicate have to be considered and carefully checked with the raw data.</p>
<p>In this case, we will assume that the leaf has only been measured once, but the data has been entered twice.
Thus, the two entries are exact duplicates.</p>
<p>We can use a similar way to fix the problem.
We group again by the variables we expect to be unique.
Then we create a new variable that counts the number of time a unique combination occurs.
And then we filter away the duplicates.
At the end, we remove the new variable and ungroup the data.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">raw_traits2</span> <span class="op">&lt;-</span> <span class="va">raw_traits</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Date</span>, <span class="va">Gradient</span>, <span class="va">Site</span>, <span class="va">PlotID</span>, <span class="va">Individual_nr</span>, <span class="va">ID</span>, <span class="va">Taxon</span>, <span class="va">Trait</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">n</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; group_by: 8 grouping variables (Date, Gradient, Site, PlotID, Individual_nr, …)</span>
<span class="co">#&gt; mutate (grouped): new variable 'n' (integer) with 2 unique values and 0% NA</span>
<span class="co">#&gt; filter (grouped): removed one row (&lt;1%), 2,820 rows remaining</span>
<span class="co">#&gt; select: dropped one variable (n)</span>
<span class="co">#&gt; ungroup: no grouping variables</span></code></pre></div>
<p>We should now check again if this code has changed the data in the correct way.
One way to check this, would be to run the code from above that checks for duplicates again.
An alternative is to use the <strong>tidylog package</strong>.</p>
</div>
<div id="check-data-cleaning-using-tidylog" class="section level3" number="5.2.5">
<h3>
<span class="header-section-number">5.2.5</span> Check data cleaning using tidylog<a class="anchor" aria-label="anchor" href="#check-data-cleaning-using-tidylog"><i class="fas fa-link"></i></a>
</h3>
<p>Tidylog packages is built on the <strong>dplyr</strong> and <strong>tidyr</strong> packages and provides useful information about the functions used.</p>
<p>Tidylog will for example tell you how many rows have been removed and are remaining when using the <code><a href="https://rdrr.io/pkg/tidylog/man/filter.html">filter()</a></code> function or how many rows match when using a join function.
This additional information is very useful, because mistakes can easily happen when transforming and cleaning data.</p>
<p>Let’s install and load the <em>tidylog package</em>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"tidylog"</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/elbersb/tidylog/">tidylog</a></span><span class="op">)</span></code></pre></div>
<p>Now we can remove the duplicates again, but this time using the tidylog version of the dyplr functions.
For clarity, the code indicates that the tidylog version is used with the following notation: <code>tidylog::</code>.
However, this notation is not necessary, because once the <em>tidylog package</em> is loaded it will automatically prioritize the tidylog function and you actively have to choose if you do not want to use it.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">raw_traits</span> <span class="op">&lt;-</span> <span class="va">raw_traits</span> |&gt; 
  <span class="fu">tidylog</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tidylog/man/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Date</span>, <span class="va">Gradient</span>, <span class="va">Site</span>, <span class="va">PlotID</span>, <span class="va">Individual_nr</span>, <span class="va">ID</span>, <span class="va">Taxon</span>, <span class="va">Trait</span><span class="op">)</span> |&gt; 
  <span class="fu">tidylog</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tidylog/man/mutate.html">mutate</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> |&gt; 
  <span class="fu">tidylog</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tidylog/man/filter.html">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> |&gt; 
  <span class="fu">tidylog</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tidylog/man/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">n</span><span class="op">)</span> |&gt; 
  <span class="fu">tidylog</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tidylog/man/ungroup.html">ungroup</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; group_by: 8 grouping variables (Date, Gradient, Site, PlotID, Individual_nr, …)</span>
<span class="co">#&gt; mutate (grouped): new variable 'n' (integer) with 2 unique values and 0% NA</span>
<span class="co">#&gt; filter (grouped): removed one row (&lt;1%), 2,820 rows remaining</span>
<span class="co">#&gt; select: dropped one variable (n)</span>
<span class="co">#&gt; ungroup: no grouping variables</span></code></pre></div>
<p>The additional information about the operations is displayed below the code in the console.
There are 8 grouping variables, and <code><a href="https://rdrr.io/pkg/tidylog/man/mutate.html">mutate()</a></code> creates a new variable with 2 unique values. As expected, one row is filtered away, which is the duplicated row.
Then one column is removed and the dataset ungrouped.</p>
<p>The information is always indicated in absolute numbers and percentage which can be very useful.</p>
</div>
<div id="check-for-missing-data" class="section level3" number="5.2.6">
<h3>
<span class="header-section-number">5.2.6</span> Check for missing data<a class="anchor" aria-label="anchor" href="#check-for-missing-data"><i class="fas fa-link"></i></a>
</h3>
<p>A common problem in a dataset are missing values.</p>
<p>How to detect missing values…</p>
<p>Once the missing values are detected one has to decide if the missing data can be recovered, or if the missing values should be removed from the dataset.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">raw_traits</span> <span class="op">&lt;-</span> <span class="va">raw_traits</span> |&gt; 
  <span class="fu"><a href="https://rdrr.io/pkg/tidylog/man/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">Value</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; filter: removed 3 rows (&lt;1%), 2,817 rows remaining</span></code></pre></div>
<p>This operation has removed 3 rows, which is the number of NA’s in the dataset.</p>
</div>
<div id="check-values-whing-variables" class="section level3" number="5.2.7">
<h3>
<span class="header-section-number">5.2.7</span> Check values whing variables<a class="anchor" aria-label="anchor" href="#check-values-whing-variables"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">raw_traits</span> |&gt; 
  <span class="fu"><a href="https://rdrr.io/pkg/tidylog/man/distinct.html">distinct</a></span><span class="op">(</span><span class="va">Taxon</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">Taxon</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>n <span class="op">=</span> <span class="cn">Inf</span><span class="op">)</span>
<span class="co">#&gt; distinct: removed 2,796 rows (99%), 21 rows remaining</span>
<span class="co">#&gt; # A tibble: 21 × 1</span>
<span class="co">#&gt;    Taxon                  </span>
<span class="co">#&gt;    &lt;chr&gt;                  </span>
<span class="co">#&gt;  1 alopecurus ovatus      </span>
<span class="co">#&gt;  2 bistorta vivipara      </span>
<span class="co">#&gt;  3 cerastium arcticum     </span>
<span class="co">#&gt;  4 dryas octopetala       </span>
<span class="co">#&gt;  5 equisetum arvense      </span>
<span class="co">#&gt;  6 festuca rubra          </span>
<span class="co">#&gt;  7 luzula confusa         </span>
<span class="co">#&gt;  8 luzula nivalis         </span>
<span class="co">#&gt;  9 micranthes nivalis     </span>
<span class="co">#&gt; 10 oxiria digyna          </span>
<span class="co">#&gt; 11 oxyra digyna           </span>
<span class="co">#&gt; 12 oxyria digina          </span>
<span class="co">#&gt; 13 oxyria digyna          </span>
<span class="co">#&gt; 14 pedicularis hirsuta    </span>
<span class="co">#&gt; 15 poa arctica            </span>
<span class="co">#&gt; 16 salix polaris          </span>
<span class="co">#&gt; 17 saxifraga cernua       </span>
<span class="co">#&gt; 18 saxifraga cespitosa    </span>
<span class="co">#&gt; 19 saxifraga hirculus     </span>
<span class="co">#&gt; 20 saxifraga oppositifolia</span>
<span class="co">#&gt; 21 silene acaulis</span></code></pre></div>
<p>4 different versions of <em>oxyra digyna</em>!
rename
alternative would be to use a dictionnary.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">raw_traits</span> <span class="op">&lt;-</span> <span class="va">raw_traits</span> |&gt; 
  <span class="fu"><a href="https://rdrr.io/pkg/tidylog/man/mutate.html">mutate</a></span><span class="op">(</span>Taxon <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">Taxon</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"oxiria digyna"</span>, <span class="st">"oxyria digina"</span>, <span class="st">"oxyra digyna"</span><span class="op">)</span>, <span class="st">"oxyria digyna"</span>, <span class="va">Taxon</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; mutate: changed 28 values (1%) of 'Taxon' (0 new NA)</span></code></pre></div>
</div>
<div id="visualise-data" class="section level3" number="5.2.8">
<h3>
<span class="header-section-number">5.2.8</span> Visualise data<a class="anchor" aria-label="anchor" href="#visualise-data"><i class="fas fa-link"></i></a>
</h3>
<p>Some errors and problems in the data are difficult to detect.
Checking if the measurements are realistic is nearly impossible by looking at a dataframe.
For this, visualising the data is much more effective.</p>
<p>Make histograms, this shows the range of the values</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">raw_traits</span> |&gt; 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Value</span>, fill <span class="op">=</span> <span class="va">Gradient</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html">geom_density</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"green4"</span>, <span class="st">"grey"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">Trait</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="5-2_data_curation_files/figure-html/hist-1.png" width="672"></div>
<p>Log transform growth variables:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">raw_traits</span> <span class="op">&lt;-</span> <span class="va">raw_traits</span> |&gt; 
  <span class="fu"><a href="https://rdrr.io/pkg/tidylog/man/mutate.html">mutate</a></span><span class="op">(</span>Value <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">Trait</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
    <span class="st">"Plant_Height_cm"</span>,
    <span class="st">"Wet_Mass_g"</span>,
    <span class="st">"Dry_Mass_g"</span>,
    <span class="st">"Leaf_Area_cm2"</span>,
    <span class="st">"Leaf_Thickness_mm"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">Value</span><span class="op">)</span>, <span class="va">Value</span><span class="op">)</span>,
    Trait <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/recode.html">recode</a></span><span class="op">(</span><span class="va">Trait</span>,
                   <span class="st">"Plant_Height_cm"</span> <span class="op">=</span> <span class="st">"Plant_Height_cm_log"</span>,
                   <span class="st">"Wet_Mass_g"</span> <span class="op">=</span> <span class="st">"Wet_Mass_g_log"</span>,
                   <span class="st">"Dry_Mass_g"</span> <span class="op">=</span> <span class="st">"Dry_Mass_g_log"</span>,
                   <span class="st">"Leaf_Area_cm2"</span> <span class="op">=</span> <span class="st">"Leaf_Area_cm2_log"</span>,
                   <span class="st">"Leaf_Thickness_mm"</span> <span class="op">=</span> <span class="st">"Thickness_mm_log"</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Warning in log(Value): NaNs produced</span>
<span class="co">#&gt; mutate: changed 1,254 values (45%) of 'Trait' (0 new NA)</span>
<span class="co">#&gt;         changed 1,254 values (45%) of 'Value' (0 new NA)</span></code></pre></div>
<p>Make plot again.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">raw_traits</span> |&gt; 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Value</span>, fill <span class="op">=</span> <span class="va">Gradient</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html">geom_density</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"green4"</span>, <span class="st">"grey"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">Trait</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="5-2_data_curation_files/figure-html/hist-log-1.png" width="672"></div>
<p>Another way to check the data is to plot correlated values against each other.
In this dataset, we can plot dry mass against leaf area. We would expect a positive correlation between the two variables, where large leaves have a higher dry mass.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">raw_traits</span> |&gt; 
  <span class="fu"><a href="https://rdrr.io/pkg/tidylog/man/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">Trait</span>, values_from <span class="op">=</span> <span class="va">Value</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Dry_Mass_g_log</span>, y <span class="op">=</span> <span class="va">Leaf_Area_cm2_log</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; pivot_wider: reorganized (Trait, Value) into (Plant_Height_cm_log, Thickness_mm_log, Wet_Mass_g_log, Dry_Mass_g_log, Leaf_Area_cm2_log, …) [was 2817x12, now 260x24]</span>
<span class="co">#&gt; Warning: Removed 12 rows containing missing values (geom_point).</span></code></pre></div>
<div class="inline-figure"><img src="5-2_data_curation_files/figure-html/plot-1.png" width="672"></div>
<p>Ops chicken foot! What happened here?</p>

</div>
</div>
<div id="bootstrapping" class="section level2" number="5.3">
<h2>
<span class="header-section-number">5.3</span> bootstrapping<a class="anchor" aria-label="anchor" href="#bootstrapping"><i class="fas fa-link"></i></a>
</h2>
<!-- fig.align = 'right',  -->
<div class="inline-figure"><img src="images/resources/Traitstrap_hex.png" width="15%" style="float:right; padding:8px"></div>
<p>This vignette explains how to use the traitstrap package (Telford et al).
For more details on the methods see Maitner et al.</p>
<p>First of all, relax and turn on some music. We have prepared the <a href="https://tinyurl.com/traitstrap">traitstrap playlist</a> for you!</p>
<div id="the-aim-of-traitstrap" class="section level3" number="5.3.1">
<h3>
<span class="header-section-number">5.3.1</span> The aim of traitstrap<a class="anchor" aria-label="anchor" href="#the-aim-of-traitstrap"><i class="fas fa-link"></i></a>
</h3>
<p>Trait distributions can be used to infer the importance of community assembly processes and the role of climate drivers in shaping species and community responses to climate change.
Community ecology has typically focused on the <strong>mean</strong>, however the <strong>higher moments</strong> (variance, skewness, and kurtosis) of trait distributions can reveal information about the various processes shaping species diversity.</p>
<div class="inline-figure"><img src="images/resources/true-dist.png" width="90%"></div>
<p>Measuring trait distributions is often difficult and time-consuming as it requires information on measuring trait values of all individuals present.
Sampling protocols often limit sampling to a non-representative subset of the community, or rely upon species-level average traits values calculated in other locations or across many locations.</p>
<p>Traditionally the moments of trait distributions have been estimated using weighting approaches that rely on the average traits of species weighted by some measure of abundance within the community.
Such <strong>community-weighted</strong> trait moments methods assume that a species’ trait expression can be adequately represented by the mean, ignoring intraspecific trait variation.</p>
<p>To more accurately estimate local trait distributions, trait sampling should thus occur both across multiple individuals within each species, and across multiple locations or experimental treatments across the extent of the study in order to capture both inter- and intra-specific variability.</p>
<div class="inline-figure"><img src="images/resources/comm-boot.png" width="90%"></div>
<p><strong>Traitstrap</strong> is an <strong>R package</strong> to estimate the moments of community trait distributions using a <strong>bootstrapping approach</strong>.
Further, this package uses a hierarchical sampling design, which allows accounting for incomplete trait collections, traits from different spatial or temporal levels (e.g. local traits vs. databases), taxonomic hierarchies (e.g., species vs genus) and experimental designs (e.g., multiple sites, or treated vs. control sampling units).</p>
<p>The package has three <strong>main functions</strong>:</p>
<ul>
<li>
<strong>trait imputation</strong> function which allows to account for intraspecific trait variation and hierarchical sampling design.</li>
<li>a resample method using <strong>bootstrapping</strong> (parametric or nonparametric method) to calculate community weighted mean and happy moments (variance, skewness and kurtosis).</li>
<li>a <strong>summary function</strong> that summarizes the trait moments and calculates confidence intervals.</li>
</ul>
<p>Note that for this tutorial we are calling the mean and the higher moments the happy moments :-)</p>
</div>
<div id="the-data" class="section level3" number="5.3.2">
<h3>
<span class="header-section-number">5.3.2</span> The data<a class="anchor" aria-label="anchor" href="#the-data"><i class="fas fa-link"></i></a>
</h3>
<p>For this vignette we will use part of a vascular plant dataset from two sites near Longyearbyen on Svalbard.
The data was collected during the Plant Functional Trait Course in 2018 and contains data on the plant community composition and functional traits.
For more details see this <a href="https://github.com/Plant-Functional-Trait-Course/PFTC_4_Svalbard">GitHub repo</a></p>
<p>Note that some of the species names have been adapted.</p>
</div>
<div id="organize-your-data" class="section level3" number="5.3.3">
<h3>
<span class="header-section-number">5.3.3</span> Organize your data<a class="anchor" aria-label="anchor" href="#organize-your-data"><i class="fas fa-link"></i></a>
</h3>
<p>To run traitstrap two datasets are required:</p>
<ul>
<li>one dataset with information on abundance (e.g. biomass, size, cover, etc.) of the community, which is used to weight species traits by abundance in the community.</li>
<li>one dataset with the traits for each species (or as many species and individuals you have data for) in your community.</li>
</ul>
<p>The datasets need to be organized in a <strong>tidy</strong> and <strong>long</strong> format and certain columns (see below) are required, but the naming of these columns are up to the user.</p>
<p>Let us have a look at these datasets in an example.</p>
<p>The <strong>community data</strong> should have information the abundance of species in the community.
This dataset will be used to weigh the traits by species abundance.
Note that abundance can also be cover, size, biomass, or something similar.</p>
<p>In this example the contains species names (e.g. <strong>Taxon</strong>), cover of each species per plot (e.g. <strong>Cover</strong>) and two columns with information about the <strong>hierarchy</strong> (i.e. <strong>Site</strong> and <strong>PlotID</strong>).</p>
<pre><code>#&gt; # A tibble: 110 × 4
#&gt;    Taxon             Cover Site  PlotID
#&gt;    &lt;chr&gt;             &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; 
#&gt;  1 alopecurus ovatus   0.5 1     B     
#&gt;  2 alopecurus ovatus   1   1     C     
#&gt;  3 alopecurus ovatus   1   1     D     
#&gt;  4 alopecurus ovatus   2   1     F     
#&gt;  5 alopecurus ovatus   0.1 1     G     
#&gt;  6 bistorta vigdis    10   1     A     
#&gt;  7 bistorta vigdis    25   1     B     
#&gt;  8 bistorta vigdis    10   1     C     
#&gt;  9 bistorta vigdis     2   1     D     
#&gt; 10 bistorta vigdis     1   1     F     
#&gt; # … with 100 more rows</code></pre>
<p>The <strong>trait data</strong> should contain information about traits and trait values for as many species and individuals in the community data as possible.
The data should be organized in the same way as the community data and should have corresponding columns.
In this example the trait data contains <strong>Taxon</strong>, <strong>Site</strong> and <strong>PlotID</strong> as well as <strong>Trait</strong> and <strong>Value</strong>.</p>
<pre><code>#&gt; # A tibble: 749 × 5
#&gt;    Taxon                   Site  PlotID Trait         Value
#&gt;    &lt;chr&gt;                   &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt;         &lt;dbl&gt;
#&gt;  1 saxifraga oppositifolia 1     A      Wet_Mass_g 0.000695
#&gt;  2 bistorta vigdis         1     C      Wet_Mass_g 0.0105  
#&gt;  3 festuca rubra           2     C      Wet_Mass_g 0.00724 
#&gt;  4 bistorta vigdis         1     C      Wet_Mass_g 0.0189  
#&gt;  5 equisetum arvense       1     E      Wet_Mass_g 0.270   
#&gt;  6 bistorta vigdis         1     B      Wet_Mass_g 0.0231  
#&gt;  7 luzula confusa          1     F      Wet_Mass_g 0.0135  
#&gt;  8 alopecurus ovatus       1     G      Wet_Mass_g 0.0234  
#&gt;  9 alopecurus ovatus       1     G      Wet_Mass_g 0.0300  
#&gt; 10 alopecurus ovatus       1     C      Wet_Mass_g 0.0267  
#&gt; # … with 739 more rows</code></pre>
</div>
<div id="trait-imputation" class="section level3" number="5.3.4">
<h3>
<span class="header-section-number">5.3.4</span> Trait imputation<a class="anchor" aria-label="anchor" href="#trait-imputation"><i class="fas fa-link"></i></a>
</h3>
<p>The <code>trait_impute</code> function uses a hierarchical sampling design, which allows to account for incomplete trait collections, traits from different spatial or temporal levels (i.e. local traits vs. databases), different taxonomic resolution and/or experimental design.</p>
<p>The first two mandatory arguments in the function are the two datasets:
<code>comm</code> and <code>traits</code></p>
<p>The next four arguments are also mandatory and refer to specific columns in the trait or community dataset:</p>
<ul>
<li>
<code>abundance</code> which is the abundance of your species in your community dataset. This can be abundance, cover, biomass, or size, etc.</li>
<li>
<code>taxon_col</code> is the column in your community and trait data that define the species.</li>
<li>
<code>trait_col</code> is the column in your trait data that defines the traits.</li>
<li>
<code>value_col</code> is the column in your trait data that defines the trait values.</li>
</ul>
<p>All the other arguments are not mandatory.</p>
<p>With <code>scale_hierarchy</code> you can define the levels at which the traits have been collected and the order of trait imputation starting with the highest level (e.g. global database, regional, site, plot).
In the example below we have the levels <strong>Site</strong> and <strong>PlotID</strong>, starting with the highest level.</p>
<p>The <code>trait_impute</code> function will choose if available a trait value from the lowest level, i.e. species X from plot A in site 1.
If no trait value is available from that level (plot A, site 1), it will other groups in the same level and choose a trait value from species X from plot B or C at site 1.
If there is no trait available, it will move up the hierarchy to the next level and choose trait values from species X from other sites (site 2, 3, etc.).</p>
<p>The argument <code>min_n_in_samples</code> allows users to define the minimum number in samples that are chosen at each level.
If the minimum number is not reached (i.e. there are only 3 trait values at a specific level), trait values from the next higher level will be imputed, to avoid sampling the same individual several times, which could result in unrealistic variances.
The default minimum number of samples is 5.</p>
<p>In the <code>other_col</code> argument other grouping variables in the community dataset can be defined and will be kept after the trait imputation.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">trait_imputation</span> <span class="op">&lt;-</span> <span class="fu">trait_impute</span><span class="op">(</span>
    <span class="co"># input data (mandatory)</span>
    comm <span class="op">=</span> <span class="va">community</span>,
    traits <span class="op">=</span> <span class="va">trait</span>,
    
    <span class="co"># specifies columns in your data (mandatory)</span>
    abundance_col <span class="op">=</span> <span class="st">"Cover"</span>,
    taxon_col <span class="op">=</span> <span class="st">"Taxon"</span>,
    trait_col <span class="op">=</span> <span class="st">"Trait"</span>,
    value_col <span class="op">=</span> <span class="st">"Value"</span>,
    
    <span class="co"># specifies sampling hierarchy</span>
    scale_hierarchy <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Site"</span>, <span class="st">"PlotID"</span><span class="op">)</span>,
    
    <span class="co"># min number of samples</span>
    min_n_in_sample <span class="op">=</span> <span class="fl">9</span>
  <span class="op">)</span>
<span class="va">trait_imputation</span>
<span class="co">#&gt; # A tibble: 4,007 × 12</span>
<span class="co">#&gt; # Groups:   global, Site, PlotID, Trait [28]</span>
<span class="co">#&gt;    Taxon  Cover Site  PlotID global sum_abun Trait   Value n_sample weight level</span>
<span class="co">#&gt;    &lt;chr&gt;  &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt;     &lt;dbl&gt; &lt;chr&gt;   &lt;dbl&gt;    &lt;int&gt;  &lt;dbl&gt; &lt;ord&gt;</span>
<span class="co">#&gt;  1 festu…     1 1     A      global     38.2 Wet_… 0.00724       11 0.0909 glob…</span>
<span class="co">#&gt;  2 festu…     1 1     A      global     38.2 Wet_… 0.0160        11 0.0909 glob…</span>
<span class="co">#&gt;  3 festu…     1 1     A      global     38.2 Wet_… 0.00529       11 0.0909 glob…</span>
<span class="co">#&gt;  4 festu…     1 1     A      global     38.2 Wet_… 0.0154        11 0.0909 glob…</span>
<span class="co">#&gt;  5 festu…     1 1     A      global     38.2 Wet_… 0.0066        11 0.0909 glob…</span>
<span class="co">#&gt;  6 festu…     1 1     A      global     38.2 Wet_… 0.00637       11 0.0909 glob…</span>
<span class="co">#&gt;  7 festu…     1 1     A      global     38.2 Wet_… 0.00491       11 0.0909 glob…</span>
<span class="co">#&gt;  8 festu…     1 1     A      global     38.2 Wet_… 0.0132        11 0.0909 glob…</span>
<span class="co">#&gt;  9 festu…     1 1     A      global     38.2 Wet_… 0.0233        11 0.0909 glob…</span>
<span class="co">#&gt; 10 festu…     1 1     A      global     38.2 Wet_… 0.0115        11 0.0909 glob…</span>
<span class="co">#&gt; # … with 3,997 more rows, and 1 more variable: max_n_in_sample &lt;int&gt;</span></code></pre></div>
<p>Traitstrap also allows to include taxonomy and experimental design in the trait imputation step.</p>
<p>With the argument <code>taxon_col</code> the taxonomic hierarchy for sampling can be defined.
This means if traits for a specific species are not available, trait values from the same genus will be imputed.
For this a list of the taxonomic hierarchy has to be defined (e.g. “Taxon”, “Genus”).
Note that traits from species of the same genus can have very different traits and it might not be meaningful to impute these traits.
Therefore, you should always check the trait distributions for the same genus before using taxonomic trait imputation.</p>
<p>The argument <code>treatment_col</code> allows to incorporate an experimental design where traits are imputed from the same experimental treatment or the first factor level, which is assumed to be the control.
Therefore, it is important to order the levels of a treatment in the right order, i.e. the first level has to be the control.
The imputation step can be defined at certain level using the <code>treatment_level</code> argument.
Depending on the experimental design it might make sense to impute traits at a certain level, e.g. block or site.</p>
<p>Here is an example how to include taxonomy and experimental design in the trait imputation function (code not run).</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="trait-data-curation-and-analysis.html#cb25-1" aria-hidden="true" tabindex="-1"></a>trait_imputation2 <span class="ot">&lt;-</span> <span class="fu">trait_impute</span>(</span>
<span id="cb25-2"><a href="trait-data-curation-and-analysis.html#cb25-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">comm =</span> community,</span>
<span id="cb25-3"><a href="trait-data-curation-and-analysis.html#cb25-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">traits =</span> trait,</span>
<span id="cb25-4"><a href="trait-data-curation-and-analysis.html#cb25-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-5"><a href="trait-data-curation-and-analysis.html#cb25-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">abundance_col =</span> <span class="st">"Cover"</span>,</span>
<span id="cb25-6"><a href="trait-data-curation-and-analysis.html#cb25-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-7"><a href="trait-data-curation-and-analysis.html#cb25-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># defining taxonomic hierarchy</span></span>
<span id="cb25-8"><a href="trait-data-curation-and-analysis.html#cb25-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">taxon_col =</span> <span class="fu">c</span>(<span class="st">"Taxon"</span>, <span class="st">"Genus"</span>),</span>
<span id="cb25-9"><a href="trait-data-curation-and-analysis.html#cb25-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-10"><a href="trait-data-curation-and-analysis.html#cb25-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">trait_col =</span> <span class="st">"Trait"</span>,</span>
<span id="cb25-11"><a href="trait-data-curation-and-analysis.html#cb25-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">value_col =</span> <span class="st">"Value"</span>,</span>
<span id="cb25-12"><a href="trait-data-curation-and-analysis.html#cb25-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-13"><a href="trait-data-curation-and-analysis.html#cb25-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">scale_hierarchy =</span> <span class="fu">c</span>(<span class="st">"Site"</span>, <span class="st">"PlotID"</span>),</span>
<span id="cb25-14"><a href="trait-data-curation-and-analysis.html#cb25-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_n_in_sample =</span> <span class="dv">3</span></span>
<span id="cb25-15"><a href="trait-data-curation-and-analysis.html#cb25-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-16"><a href="trait-data-curation-and-analysis.html#cb25-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># specifying experimental design</span></span>
<span id="cb25-17"><a href="trait-data-curation-and-analysis.html#cb25-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">treatment_col =</span> <span class="st">"Treatment"</span>,</span>
<span id="cb25-18"><a href="trait-data-curation-and-analysis.html#cb25-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">treatment_level =</span> <span class="st">"Site"</span>,</span>
<span id="cb25-19"><a href="trait-data-curation-and-analysis.html#cb25-19" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
</div>
<div id="nonparametric-bootstrapping" class="section level3" number="5.3.5">
<h3>
<span class="header-section-number">5.3.5</span> Nonparametric bootstrapping<a class="anchor" aria-label="anchor" href="#nonparametric-bootstrapping"><i class="fas fa-link"></i></a>
</h3>
<p>The output of the trait imputation function is then used to do a <strong>nonparametric bootstrapping</strong> using the <code>trait_np_bootstrap</code> function.</p>
<p>Nonparametric bootstrapping is a resampling method to estimate the trait moments.
The traits are re-sampled in proportion to their weight in the community (e.g. by the abundance of the species).</p>
<p>The trait values across all individuals in a community are resampled n times (<code>sample_size</code>; the default is 200) to incorporate the full spectrum of trait variation, generating n number (<code>nrep</code>; the default is 100) of trait distributions.</p>
<p>From these trait distributions the happy moments are estimated: <strong>mean</strong>, <strong>variance</strong>, <strong>skewness</strong> and <strong>kurtosis</strong>.</p>
<p>This function also allows to extract raw distributions by setting the argument <code>raw = TRUE</code>.
The raw data can be useful for visualizing the trait distributions.
If the raw data is extracted, <code>nrep</code> is forced to 1 to avoid memory issues.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># run nonparametric bootstrapping</span>
<span class="va">np_bootstrapped_moments</span> <span class="op">&lt;-</span> <span class="fu">trait_np_bootstrap</span><span class="op">(</span>
  <span class="va">trait_imputation</span>, 
  nrep <span class="op">=</span> <span class="fl">200</span>
  <span class="op">)</span>
<span class="va">np_bootstrapped_moments</span>
<span class="co">#&gt; # A tibble: 5,600 × 9</span>
<span class="co">#&gt; # Groups:   global, Site, PlotID [14]</span>
<span class="co">#&gt;    n     global Site  PlotID Trait             mean   variance skewness kurtosis</span>
<span class="co">#&gt;    &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt;            &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;</span>
<span class="co">#&gt;  1 1     global 1     A      Plant_Height_cm 1.74    2.77         2.91    9.64  </span>
<span class="co">#&gt;  2 1     global 1     A      Wet_Mass_g      0.0119  0.0000605    0.823   1.07  </span>
<span class="co">#&gt;  3 1     global 1     B      Plant_Height_cm 1.67    2.47         3.19   12.1   </span>
<span class="co">#&gt;  4 1     global 1     B      Wet_Mass_g      0.0134  0.0000551    0.539  -0.0454</span>
<span class="co">#&gt;  5 1     global 1     C      Plant_Height_cm 1.86    2.07         2.24    5.77  </span>
<span class="co">#&gt;  6 1     global 1     C      Wet_Mass_g      0.0153  0.000116     3.07   14.2   </span>
<span class="co">#&gt;  7 1     global 1     D      Plant_Height_cm 1.82    4.37         2.78    7.28  </span>
<span class="co">#&gt;  8 1     global 1     D      Wet_Mass_g      0.0125  0.0000664    2.95   16.3   </span>
<span class="co">#&gt;  9 1     global 1     E      Plant_Height_cm 7.14   18.3          0.338  -0.557 </span>
<span class="co">#&gt; 10 1     global 1     E      Wet_Mass_g      0.0152  0.000226     3.24   10.0   </span>
<span class="co">#&gt; # … with 5,590 more rows</span></code></pre></div>
<p>One advantage of using a bootstrapping approach, is that we get much more than a mean trait value.
We can also estimate the variance and other moments of these trait distributions.
In traitstrap happy moments can be summarized and the confidence intervals calculated using the <code>trait_summarise_boot_moments</code> function.
The input variable for this function is the output from the nonparametric bootstrapping function (or the parametric bootstrapping function, see below).</p>
<p>The confidence interval can be calculated parametrically, using the mean and standard deviation, or nonparametrically using quantiles.
The default is using the mean and standard deviation (<code>parametric = TRUE</code>) with one standard deviation around each trait moment (<code>sd_mult = 1</code>).
For the nonparametric approach the default is a 0.95 confidence level.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># summarizes bootstrapping output</span>
<span class="va">sum_boot_moment</span> <span class="op">&lt;-</span> <span class="fu">trait_summarise_boot_moments</span><span class="op">(</span>
  <span class="va">np_bootstrapped_moments</span>
  <span class="op">)</span>
<span class="va">sum_boot_moment</span>
<span class="co">#&gt; # A tibble: 28 × 17</span>
<span class="co">#&gt; # Groups:   global, Site, PlotID [14]</span>
<span class="co">#&gt;    global Site  PlotID Trait           n   mean ci_low_mean ci_high_mean     var</span>
<span class="co">#&gt;    &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt;       &lt;int&gt;  &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;   &lt;dbl&gt;</span>
<span class="co">#&gt;  1 global 1     A      Plant_Heig…   200 1.72        1.60         1.84   2.62e+0</span>
<span class="co">#&gt;  2 global 1     A      Wet_Mass_g    200 0.0121      0.0115       0.0126 6.55e-5</span>
<span class="co">#&gt;  3 global 1     B      Plant_Heig…   200 1.76        1.65         1.87   2.68e+0</span>
<span class="co">#&gt;  4 global 1     B      Wet_Mass_g    200 0.0137      0.0131       0.0143 7.02e-5</span>
<span class="co">#&gt;  5 global 1     C      Plant_Heig…   200 1.73        1.63         1.83   1.90e+0</span>
<span class="co">#&gt;  6 global 1     C      Wet_Mass_g    200 0.0149      0.0141       0.0157 1.34e-4</span>
<span class="co">#&gt;  7 global 1     D      Plant_Heig…   200 1.86        1.71         2.02   4.67e+0</span>
<span class="co">#&gt;  8 global 1     D      Wet_Mass_g    200 0.0118      0.0113       0.0123 5.22e-5</span>
<span class="co">#&gt;  9 global 1     E      Plant_Heig…   200 7.07        6.80         7.35   1.71e+1</span>
<span class="co">#&gt; 10 global 1     E      Wet_Mass_g    200 0.0161      0.0150       0.0172 2.74e-4</span>
<span class="co">#&gt; # … with 18 more rows, and 8 more variables: ci_low_var &lt;dbl&gt;,</span>
<span class="co">#&gt; #   ci_high_var &lt;dbl&gt;, skew &lt;dbl&gt;, ci_low_skew &lt;dbl&gt;, ci_high_skew &lt;dbl&gt;,</span>
<span class="co">#&gt; #   kurt &lt;dbl&gt;, ci_low_kurt &lt;dbl&gt;, ci_high_kurt &lt;dbl&gt;</span></code></pre></div>
</div>
<div id="parametric-bootstrapping" class="section level3" number="5.3.6">
<h3>
<span class="header-section-number">5.3.6</span> Parametric bootstrapping<a class="anchor" aria-label="anchor" href="#parametric-bootstrapping"><i class="fas fa-link"></i></a>
</h3>
<p>Traitstrap also offers the option to run a <strong>parametric bootstrapping</strong>.</p>
<p>The <code>trait_fit_distributions</code> function fits parametric distributions for each species-by-trait combination at the finest scale of the user-supplied hierarchy.
This function takes as input:</p>
<ul>
<li>an object of class imputed traits (as produced by the function <code>trait_impute</code>), and</li>
<li>the type of distribution to be fitted.</li>
</ul>
<p>Either a single distribution type can be used for all traits, or traits can be assigned specific distributions types by supplying the function with a named list of traits (e.g. <code>list(height = "normal", mass = "lognormal")</code>).</p>
<p>Currently the function supports normal, log-normal, and beta (values between 0 and 1) distributions.</p>
<p>The function returns a dataframe containing fitted distribution parameters.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># fit distributions</span>
<span class="va">fitted_distributions</span> <span class="op">&lt;-</span> <span class="fu">trait_fit_distributions</span><span class="op">(</span>
  imputed_traits <span class="op">=</span> <span class="va">trait_imputation</span>,
  distribution_type <span class="op">=</span> <span class="st">"lognormal"</span>
  <span class="op">)</span>
<span class="co">#&gt; Warning in .data[["Trait"]] == names(distribution_type)[distribution_type == :</span>
<span class="co">#&gt; longer object length is not a multiple of shorter object length</span>
<span class="va">fitted_distributions</span>
<span class="co">#&gt; # A tibble: 202 × 15</span>
<span class="co">#&gt; # Groups:   global, Site, PlotID, Trait, Taxon, Cover, n_sample [202]</span>
<span class="co">#&gt;    global Site  PlotID Trait  Taxon Cover n_sample distribution_ty…  parm1 parm2</span>
<span class="co">#&gt;    &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt; &lt;dbl&gt;    &lt;int&gt; &lt;chr&gt;             &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt;  1 global 1     A      Plant… bist…  10         28 lognormal         0.328 0.517</span>
<span class="co">#&gt;  2 global 1     A      Plant… drya…   0.1        9 lognormal         1.04  0.704</span>
<span class="co">#&gt;  3 global 1     A      Plant… fest…   1         11 lognormal         1.61  0.377</span>
<span class="co">#&gt;  4 global 1     A      Plant… luzu…   0.5       15 lognormal         1.50  0.325</span>
<span class="co">#&gt;  5 global 1     A      Plant… luzu…   1         20 lognormal         0.588 0.459</span>
<span class="co">#&gt;  6 global 1     A      Plant… sali…  20         44 lognormal        -0.138 0.931</span>
<span class="co">#&gt;  7 global 1     A      Plant… saxi…   2          6 lognormal         1.13  0.469</span>
<span class="co">#&gt;  8 global 1     A      Plant… saxi…   2          2 lognormal         0.693 0    </span>
<span class="co">#&gt;  9 global 1     A      Plant… sile…   1          3 lognormal        -0.221 0.277</span>
<span class="co">#&gt; 10 global 1     A      Wet_M… bist…  10         29 lognormal        -4.06  0.454</span>
<span class="co">#&gt; # … with 192 more rows, and 5 more variables: sd1 &lt;lgl&gt;, sd2 &lt;lgl&gt;, ks &lt;dbl&gt;,</span>
<span class="co">#&gt; #   cvm &lt;dbl&gt;, ad &lt;dbl&gt;</span></code></pre></div>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># fit several types of distributions</span>
<span class="va">fitted_distributions</span> <span class="op">&lt;-</span> <span class="fu">trait_fit_distributions</span><span class="op">(</span>
  imputed_traits <span class="op">=</span> <span class="va">trait_imputation</span>,
  distribution_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>Plant_Height_cm <span class="op">=</span> <span class="st">"normal"</span>, Wet_Mass_g <span class="op">=</span> <span class="st">"lognormal"</span><span class="op">)</span>
  <span class="op">)</span>
<span class="va">fitted_distributions</span></code></pre></div>
<p>The <code>trait_parametric_bootstrap</code> function is a parametric analogue of the <code>trait_np_bootstrap</code> function.
It takes in fitted trait distributions produced by <code>trait_fit_distributions</code> and randomly samples from among the fitted distributions proportionally to species abundances in the community.</p>
<p>As with <code>trait_np_bootstrap</code>, the number of samples per replicated draw are specified with the parameter <code>sample_size</code>, and the number of replicated draws is specified by the parameter <code>nrep.</code>
The argument <code>raw</code> allows to extract raw distributions (see above).</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># run parametric bootstrapping</span>
<span class="va">p_bootstrapped_moments</span> <span class="op">&lt;-</span> <span class="fu">trait_parametric_bootstrap</span><span class="op">(</span>
    fitted_distributions <span class="op">=</span> <span class="va">fitted_distributions</span>, 
    nrep <span class="op">=</span> <span class="fl">200</span>
    <span class="op">)</span>
<span class="va">p_bootstrapped_moments</span>
<span class="co">#&gt; # A tibble: 5,600 × 9</span>
<span class="co">#&gt; # Groups:   global, Site, PlotID, Trait [28]</span>
<span class="co">#&gt;    n     global Site  PlotID Trait             mean   variance skewness kurtosis</span>
<span class="co">#&gt;    &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt;            &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;</span>
<span class="co">#&gt;  1 1     global 1     A      Plant_Height_cm 1.65    1.83         1.83     4.19 </span>
<span class="co">#&gt;  2 1     global 1     A      Wet_Mass_g      0.0113  0.0000567    1.27     2.57 </span>
<span class="co">#&gt;  3 1     global 1     B      Plant_Height_cm 1.72    2.90         2.40     7.54 </span>
<span class="co">#&gt;  4 1     global 1     B      Wet_Mass_g      0.0132  0.0000771    2.60     9.66 </span>
<span class="co">#&gt;  5 1     global 1     C      Plant_Height_cm 1.69    1.90         2.59     7.96 </span>
<span class="co">#&gt;  6 1     global 1     C      Wet_Mass_g      0.0144  0.000139     5.80    52.2  </span>
<span class="co">#&gt;  7 1     global 1     D      Plant_Height_cm 1.69    3.22         2.24     6.02 </span>
<span class="co">#&gt;  8 1     global 1     D      Wet_Mass_g      0.0113  0.0000374    1.81     5.52 </span>
<span class="co">#&gt;  9 1     global 1     E      Plant_Height_cm 7.08   16.5          0.438    0.824</span>
<span class="co">#&gt; 10 1     global 1     E      Wet_Mass_g      0.0150  0.000166     2.32     7.68 </span>
<span class="co">#&gt; # … with 5,590 more rows</span></code></pre></div>
<p>The output of trait_parametric_bootstrap can be summarized using <code>trait_summarize_boot_moments</code> (see above).</p>
</div>
<div id="extracting-raw-distributions" class="section level3" number="5.3.7">
<h3>
<span class="header-section-number">5.3.7</span> Extracting raw distributions<a class="anchor" aria-label="anchor" href="#extracting-raw-distributions"><i class="fas fa-link"></i></a>
</h3>
<p>In traitstrap both the parametric and nonparametric bootstrapping functions allow returning raw trait distributions.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># run nonparametric bootstrapping</span>
<span class="va">raw_dist_np</span> <span class="op">&lt;-</span> <span class="fu">trait_np_bootstrap</span><span class="op">(</span>
  <span class="va">trait_imputation</span>,
  raw <span class="op">=</span> <span class="cn">TRUE</span>
  <span class="op">)</span>
<span class="va">raw_dist_np</span>
<span class="co">#&gt; # A tibble: 5,600 × 13</span>
<span class="co">#&gt; # Groups:   global, Site, PlotID, Trait [28]</span>
<span class="co">#&gt;    n     Taxon    Cover Site  PlotID global sum_abun Trait Value n_sample weight</span>
<span class="co">#&gt;    &lt;chr&gt; &lt;chr&gt;    &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt;     &lt;dbl&gt; &lt;chr&gt; &lt;dbl&gt;    &lt;int&gt;  &lt;dbl&gt;</span>
<span class="co">#&gt;  1 1     salix p…    20 1     A      global     38.2 Plan…   1.5       44  0.455</span>
<span class="co">#&gt;  2 1     bistort…    10 1     A      global     38.2 Plan…   0.5       28  0.357</span>
<span class="co">#&gt;  3 1     bistort…    10 1     A      global     38.2 Plan…   0.8       28  0.357</span>
<span class="co">#&gt;  4 1     salix p…    20 1     A      global     38.2 Plan…   1         44  0.455</span>
<span class="co">#&gt;  5 1     salix p…    20 1     A      global     38.2 Plan…   1.6       44  0.455</span>
<span class="co">#&gt;  6 1     saxifra…     2 1     A      global     38.2 Plan…   4.9        6  0.333</span>
<span class="co">#&gt;  7 1     salix p…    20 1     A      global     38.2 Plan…   2         44  0.455</span>
<span class="co">#&gt;  8 1     salix p…    20 1     A      global     38.2 Plan…   1         44  0.455</span>
<span class="co">#&gt;  9 1     bistort…    10 1     A      global     38.2 Plan…   1.1       28  0.357</span>
<span class="co">#&gt; 10 1     salix p…    20 1     A      global     38.2 Plan…   1.1       44  0.455</span>
<span class="co">#&gt; # … with 5,590 more rows, and 2 more variables: level &lt;ord&gt;,</span>
<span class="co">#&gt; #   max_n_in_sample &lt;int&gt;</span></code></pre></div>
<p>The raw data can be useful for visualizing the trait distributions.</p>
<p>Use colour and facets to separate between the different traits, hierarchies and treatments.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">raw_dist_np</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">Value</span><span class="op">)</span>, fill <span class="op">=</span> <span class="va">Site</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html">geom_density</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html">scale_fill_viridis_d</a></span><span class="op">(</span>end <span class="op">=</span> <span class="fl">0.9</span>, option <span class="op">=</span> <span class="st">"plasma"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"log(trait value)"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span> <span class="op">~</span> <span class="va">Trait</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="5-3_bootstrapping_files/figure-html/plot-raw-dist-np-1.png" width="576"></div>
</div>
<div id="check-your-data" class="section level3" number="5.3.8">
<h3>
<span class="header-section-number">5.3.8</span> Check your data<a class="anchor" aria-label="anchor" href="#check-your-data"><i class="fas fa-link"></i></a>
</h3>
<p>Traitstrap has a couple of functions to check the data.</p>
<p>The <code>coverage_plot</code> function shows the trait coverage of the community for each level.
Basically, this function summarizes from which level the traits are imputed, and how much coverage of the community is reached.</p>
<p>Based on simulations, we recommend to collect traits for at least 80% of the community cover (Maitner et al. in prep).</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># show coverage plot</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">trait_imputation</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">8</span>, angle <span class="op">=</span> <span class="fl">90</span>, vjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="5-3_bootstrapping_files/figure-html/coverage-plot-1.png" width="576"></div>
<p>Another important information is to know of which taxa traits are missing.
This can be useful if the data sampling is not finished and you want to know which species should be sampled.
The function also tells you the maximal abundance of each missing species, and gives you useful information if the missing species are abundant or rare.</p>
<p>Traitstrap has a function <code>trait_missing</code> which gives you a table with all missing values.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># list missing traits</span>
<span class="fu">trait_missing</span><span class="op">(</span>imputed_trait <span class="op">=</span> <span class="va">trait_imputation</span>,
              comm <span class="op">=</span> <span class="va">community</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 20 × 3</span>
<span class="co">#&gt; # Groups:   Taxon [20]</span>
<span class="co">#&gt;    Taxon                      max_abun n_traits</span>
<span class="co">#&gt;    &lt;chr&gt;                         &lt;dbl&gt;    &lt;int&gt;</span>
<span class="co">#&gt;  1 alopecurus ovatus               2          2</span>
<span class="co">#&gt;  2 bistorta vigdis                25          2</span>
<span class="co">#&gt;  3 calamagrostis neglecta         60          2</span>
<span class="co">#&gt;  4 cassiope tetragona              5          2</span>
<span class="co">#&gt;  5 dryas octopetala               20          2</span>
<span class="co">#&gt;  6 enquistetum scirpoides          2          2</span>
<span class="co">#&gt;  7 festuca rubra                   1          2</span>
<span class="co">#&gt;  8 juncus biglumis                 0.5        1</span>
<span class="co">#&gt;  9 luzula confusa                  5          2</span>
<span class="co">#&gt; 10 luzula nivalis                  5          2</span>
<span class="co">#&gt; 11 maitneranthes hieracifolia      0.5        1</span>
<span class="co">#&gt; 12 oxyria tanyna                   2          2</span>
<span class="co">#&gt; 13 poa pratensis                   1          2</span>
<span class="co">#&gt; 14 salix polaris                  43          2</span>
<span class="co">#&gt; 15 saxifraga hirculus              2          2</span>
<span class="co">#&gt; 16 saxifraga oppositifolia         2          2</span>
<span class="co">#&gt; 17 silene acaudis                  1          2</span>
<span class="co">#&gt; 18 stelfordaria humifusa           0.5        1</span>
<span class="co">#&gt; 19 stellaria longipes              0.1        1</span>
<span class="co">#&gt; 20 trisetum spicatum               3          2</span></code></pre></div>

<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Perez-Harguindeguy2013-nv" class="csl-entry">
Pérez-Harguindeguy, N, S Dı́az, E Garnier, S Lavorel, H Poorter, P Jaureguiberry, M S Bret-Harte, et al. 2013. <span>“New Handbook for Standardised Measurement of Plant Functional Traits Worldwide.”</span> <em>Australian Journal of Botany</em>.
</div>
<div id="ref-Vandvik2020-hu" class="csl-entry">
Vandvik, Vigdis, Olav Skarpaas, Kari Klanderud, Richard J Telford, Aud H Halbritter, and Deborah E Goldberg. 2020. <span>“Biotic Rescaling Reveals Importance of Species Interactions for Variation in Biodiversity Responses to Climate Change.”</span> <em>Proc. Natl. Acad. Sci. U. S. A.</em> 117 (37): 22858–65.
</div>
<div id="ref-Yang2018-uq" class="csl-entry">
Yang, Yan, Aud Helen Halbritter, Kari Klanderud, Richard J Telford, Genxu Wang, and Vigdis Vandvik. 2018. <span>“Transplants, Open Top Chambers (<span>OTCs</span>) and Gradient Studies Ask Different Questions in Climate Change Effects Studies.”</span> <em>Front. Plant Sci.</em> 9: 1574.
</div>
</div>
</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="working-with-pftc-data.html"><span class="header-section-number">4</span> Working with PFTC data</a></div>
<div class="empty"></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#trait-data-curation-and-analysis"><span class="header-section-number">5</span> Trait data curation and analysis</a></li>
<li><a class="nav-link" href="#introduction-to-rrstudio-data-analysis-and-more"><span class="header-section-number">5.1</span> Introduction to R/RStudio, data analysis and more</a></li>
<li>
<a class="nav-link" href="#data-curation"><span class="header-section-number">5.2</span> Data curation</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#import-data"><span class="header-section-number">5.2.1</span> Import data</a></li>
<li><a class="nav-link" href="#first-check-of-the-dataset"><span class="header-section-number">5.2.2</span> First check of the dataset</a></li>
<li><a class="nav-link" href="#check-the-data-typeclass"><span class="header-section-number">5.2.3</span> Check the data type/class</a></li>
<li><a class="nav-link" href="#exercise-1">Exercise</a></li>
<li><a class="nav-link" href="#check-for-duplicates"><span class="header-section-number">5.2.4</span> Check for duplicates</a></li>
<li><a class="nav-link" href="#check-data-cleaning-using-tidylog"><span class="header-section-number">5.2.5</span> Check data cleaning using tidylog</a></li>
<li><a class="nav-link" href="#check-for-missing-data"><span class="header-section-number">5.2.6</span> Check for missing data</a></li>
<li><a class="nav-link" href="#check-values-whing-variables"><span class="header-section-number">5.2.7</span> Check values whing variables</a></li>
<li><a class="nav-link" href="#visualise-data"><span class="header-section-number">5.2.8</span> Visualise data</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#bootstrapping"><span class="header-section-number">5.3</span> bootstrapping</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#the-aim-of-traitstrap"><span class="header-section-number">5.3.1</span> The aim of traitstrap</a></li>
<li><a class="nav-link" href="#the-data"><span class="header-section-number">5.3.2</span> The data</a></li>
<li><a class="nav-link" href="#organize-your-data"><span class="header-section-number">5.3.3</span> Organize your data</a></li>
<li><a class="nav-link" href="#trait-imputation"><span class="header-section-number">5.3.4</span> Trait imputation</a></li>
<li><a class="nav-link" href="#nonparametric-bootstrapping"><span class="header-section-number">5.3.5</span> Nonparametric bootstrapping</a></li>
<li><a class="nav-link" href="#parametric-bootstrapping"><span class="header-section-number">5.3.6</span> Parametric bootstrapping</a></li>
<li><a class="nav-link" href="#extracting-raw-distributions"><span class="header-section-number">5.3.7</span> Extracting raw distributions</a></li>
<li><a class="nav-link" href="#check-your-data"><span class="header-section-number">5.3.8</span> Check your data</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>PFTC Teaching Material</strong>" was written by Aud Halbritter. It was last built on 2022-04-13.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>
</body>
</html>
